name: Build WASM Artifacts

on:
  workflow_dispatch:
  repository_dispatch:
    types: [sha3-visualizer-updated, raft-updated]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout sha3-visualizer
        uses: actions/checkout@v4
        with:
          repository: thesandybridge/sha3-visualizer
          path: sha3-visualizer

      - name: Checkout raft
        uses: actions/checkout@v4
        with:
          repository: thesandybridge/raft-consensus
          path: raft-consensus

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            sha3-visualizer/target/wasm32-unknown-unknown
            raft-consensus/target/wasm32-unknown-unknown
          key: ${{ runner.os }}-cargo-wasm-${{ hashFiles('sha3-visualizer/Cargo.lock', 'raft-consensus/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-wasm-

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build sha3-visualizer WASM
        run: |
          wasm-pack build sha3-visualizer \
            --target web \
            --out-dir ${{ github.workspace }}/public/wasm/sha3 \
            --release
          rm -f public/wasm/sha3/.gitignore

      - name: Build raft WASM
        run: |
          wasm-pack build raft-consensus \
            --target web \
            --out-dir ${{ github.workspace }}/public/wasm/raft \
            --release
          rm -f public/wasm/raft/.gitignore

      - name: Commit updated artifacts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f public/wasm/sha3/ public/wasm/raft/
          if ! git diff --cached --quiet; then
            git commit -m "chore: rebuild wasm artifacts [skip ci]"
            git push
          else
            echo "wasm artifacts unchanged, skipping commit"
          fi
